{% extends 'shop/basic.html' %}

{% block title %} Home {% endblock %}

{% load static %}
{% block body %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Page</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="{% static 'template/table_menu.css' %}">
    <style>
        .list-group-item {
            border-right:none;
            border-left:none;
            background-color:transparent;
        }
        .fa, .fas {
            padding: 12px;
            font-weight: 900;
        }
        .clear-cart{
            text-decoration:none;
            color:white;
        }
        .clear-cart:hover{
            text-decoration:none;
            color:#FAF9F6;

        }
    </style>
</head>
<main-body><br><br><br><br>
    <div id="notification" class="alert alert-primary" role="alert"></div><br>
    
    <div class="sidebar" id="sidebar">
        <div class="heading">
            <h2>MENU</h2>
        </div>
        {% for category, subcats in allProds %}
        <ul>
            <li>
                <a href="javascript:void(0)" class="category-link" data-category="{{ category }}">
                    {{ category|upper }}
                </a>
            </li>
            <ul class="subcategory-list" id="subcats-{{ category }}">
                {% for subcategory, products in subcats %}
                <li>
                    <a href="javascript:void(0)" class="subcategory-link" data-category="{{ category }}" data-subcategory="{{ subcategory }}">
                        {{ subcategory|title }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </ul>
        {% endfor %}
    </div>

    <div class="main-content" id="product-container">
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Search..." />
            <button id="search-btn">Search</button>
        </div>

        <div id="no-results-message"class="menu-items" style="display: none; color: red;">
            <center>No products matching this NAME.</center>
        </div>
        
        {% for category, subcats in allProds %}
        {% for subcategory, products in subcats %}
        <div class="category" data-subcategory="{{ subcategory }}" style="display: none;">
            {{ subcategory }}
            <div class="menu-items">
                {% for product in products %}
                <div class="menu-items">
                    <div>
                        <h5 id="namepr{{ product.id }}" class="product-name card-title" style="display:none;">{{ product.product_name }}</h5>
                        <h6 id="pricepr{{ product.id }}" class="product-price" style="color: #ff0000">Rs. {{ product.price }} /-</h6>
                        <div id="divpr{{ product.id }}" class="divpr">
                            <button id="pr{{ product.id }}" class="menu-item cart">{{ product.product_name }}<span style="
                                position: absolute; 
                                left: 0; 
                                top: 0; 
                                width: 5px; 
                                height: 100%; 
                                background-color: {% if category == 'veg' %} green {% elif category == 'nonveg' %} red {% endif %};
                                ">
                            </span></button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% endfor %}
    </div>



    <div class="container my-4" style="display:none;">
       <center> <h3>Cart Items</h3></center>
        <div id="cartItems" class="product-container"></div>
    </div>
    <style>
        .fa-search {
            font-size: 16px;
            padding: 0px;
        }
    </style>
    <div class="order-section">
        <div class="order-header">
            <div>
                <button id="refreshCart"><i class="fa fa-search" aria-hidden="true"></i> CHECK IN</button>
                <button>DELIVERY</button>
                <button>PICK UP</button>
            </div>
        </div>
        <div class="order-list">
            <ul class="list-group" id="items"></ul>
        </div>
        <div class="order-footer">
            <button id="clearCart">Clear Cart</button>
            <button id="refreshPage" class="btn btn-secondary">Final Check</button>
            <li class="list-group-item d-flex justify-content-between align-items-center" style="background: bisque;">
                <span>TOTAL PRICE:</span>
                <span class="badge badge-danger badge-pill" id="totalPrice">Rs. 0 /-</span>
            </li>
        </div>

    <!-- Form for Checkout -->
<form method="POST" action="{% url 'shop:checkout' %}" id="checkoutForm" onsubmit="return validatePaymentMethod();">
    {% csrf_token %}
    <!-- Other input fields -->
    
    <input type="hidden" name="amount" value="{{ amount }}">  <!-- Ensure amount is set correctly -->
    
    <div class="order-footer-payment">
        <div class="payment-options">
            <label>
                <input type="radio" name="payment_method" value="cash"> Cash
            </label>
            <label>
                <input type="radio" name="payment_method" value="online"> Online
            </label>
            <label>
                <input type="radio" name="payment_method" value="card"> Card
            </label>
            <label>
                <input type="radio" name="payment_method" value="other"> Other
            </label>
        </div>
    
        <!-- Additional input for "Other" payment method -->
        <div id="payment_comments_container" style="display:none;">
            <label for="payment_comments">Comments :</label>
            <input type="text" name="payment_comments" id="payment_comments" class="form-control" placeholder="Enter comment">
        </div>
    </div>

    <div id="payment-alert" style="display: none; background-color: #d4edda; color: #155724; padding: 10px; border: 1px solid #c3e6cb;">
        Please choose a payment method!
    </div>

        <!-- Print Button -->
        
    
        {% if user.is_authenticated %}
        <div class="final-options">
            <form method="post" action="/shop/checkout/" id="checkoutForm">
                {% csrf_token %}
                <input type="hidden" name="itemsJson" id="itemsJson">
                <input type="hidden" name="amount" id="amount">
                <input type="hidden" name="user_id" id="user_id" value="{{ request.user.id }}">
                
                <div class="print">
                    <button type="submit" name="action" value="save">Save</button>
                    <button class="btn btn-info" id="printCartItems"> Save & Print</button>
                </div>
            </form> 
        </form>
        
            <div class="print">
                <button id="printReceipt">Counter Print</button>
                <button type="submit" name="action" value="save_bill">Save & Bill</button>
                <button type="submit" name="action" value="kot">KOT</button>
                <button type="submit" name="action" value="kot_print">KOT & Print</button>
            </div>
        </div>
  

<!-- Modal for Payment Comments -->
<div id="commentModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
    <div style="background-color:white; margin:20% auto; padding:20px; width:300px; text-align:center; border-radius:5px;">
        <h3>Enter Your Comments</h3>
        <textarea id="modal_payment_comments" class="form-control" placeholder="Enter comments here..."></textarea>
        <br>
        <button id="submitComments" style="margin-top:10px;">Submit</button>
        <button onclick="closeModal()" style="margin-top:10px;">Cancel</button>
    </div>
</div>
        {% else %}
        <div id="cont2">
            <div class="alert alert-info">
                <font style="font-size:22px"><center>Before Save you need to <strong><a class="alert-link" data-toggle="modal" data-target="#loginModal">Login</a></strong></center></font>
            </div>
        </div>
        {% endif %}
</main-body>
<script src="{% static 'template/table_menu.js' %}"></script>
{% endblock %}

{% block js %}
{% comment %} select payment method  {% endcomment %}


        <script>
            
            //pyment method selected
                function validatePaymentMethod() {
                    const paymentMethods = document.getElementsByName('payment_method');
                    let isSelected = false;

                    for (const method of paymentMethods) {
                        if (method.checked) {
                            isSelected = true;
                            break;
                        }
                    }

                    const alertDiv = document.getElementById('payment-alert');
                    if (!isSelected) {
                        alertDiv.style.display = 'block'; // Show alert if no payment method is selected
                        return false; // Prevent form submission
                    } else {
                        alertDiv.style.display = 'none'; // Hide alert if a payment method is selected
                        return true; // Allow form submission
                    }
                }
        </script>

       


<script>
    // JavaScript to toggle comments field for "Other" payment method
    const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
    const paymentCommentsContainer = document.getElementById('payment_comments_container');
    const paymentCommentsInput = document.getElementById('payment_comments');
    const modal = document.getElementById('commentModal');
    const modalCommentsInput = document.getElementById('modal_payment_comments');

    paymentRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'other') {
                modal.style.display = 'block'; // Show the modal for comments
            } else {
                paymentCommentsContainer.style.display = 'none';
                paymentCommentsInput.value = ''; // Clear the input if not "Other"
            }
        });
    });

    // Close modal function
    function closeModal() {
        modal.style.display = 'none';
        modalCommentsInput.value = ''; // Clear the modal input when closed
    }

    // Submit comments from modal
    document.getElementById('submitComments').addEventListener('click', function() {
        const comments = modalCommentsInput.value.trim();
        if (comments) {
            paymentCommentsInput.value = comments; // Set the comments input
            closeModal(); // Close the modal
            paymentCommentsContainer.style.display = 'block'; // Show comments container
        } else {
            alert('Please enter a comment before submitting.');
        }
    });

    // Validation function
    function validatePaymentMethod() {
        const paymentMethods = document.getElementsByName('payment_method');
        let isSelected = false;

        for (const method of paymentMethods) {
            if (method.checked) {
                isSelected = true;
                break;
            }
        }

        const alertDiv = document.getElementById('payment-alert');
        if (!isSelected) {
            alertDiv.style.display = 'block'; // Show alert if no payment method is selected
            return false; // Prevent form submission
        } else {
            alertDiv.style.display = 'none'; // Hide alert if a payment method is selected
            return true; // Allow form submission
        }
    }
</script>




<script>
    // Function to print the cart items
    function printCartItems() {
        let items = document.querySelectorAll('#items li');
        let totalPriceText = document.getElementById('totalPrice').innerText;

        let printWindow = window.open('', 'Print Order', 'width=600,height=400');
        printWindow.document.write('<html><head><title>ROYAL SHETKARI</title>');
        printWindow.document.write('<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">');
        printWindow.document.write('<style>@media print { @page { size: auto; margin: 10mm; } .no-print { display: none; } }</style>');
        printWindow.document.write('</head><body>');

        printWindow.document.write('<div class="container">');
        printWindow.document.write('<h3>Your Cart Items</h3>');

        let subtotal = 0;
        let totalQuantity = 0;
        let itemCount = 0;

        printWindow.document.write('<ul class="list-group">');
        items.forEach((item) => {
            let itemName = item.querySelector('.item-name') ? item.querySelector('.item-name').innerText : 'Unknown';
            let itemQty = item.querySelector('.qty-input') ? parseInt(item.querySelector('.qty-input').value) : 0;
            let itemPrice = item.querySelector('.original-item-price') ? parseFloat(item.querySelector('.original-item-price').innerText.replace('Rs. ', '').trim()) : 0;

            if (itemName === 'Unknown' || itemQty === 0) return;

            itemCount++;
            let itemTotal = itemQty * itemPrice;

            printWindow.document.write('<li class="list-group-item d-flex justify-content-between align-items-center">' +
                itemCount + ': ' + itemName +
                '<span>(Qty: ' + itemQty +
                ', Unit Price: Rs. ' + itemPrice.toFixed(2) +
                ', Total: Rs. ' + itemTotal.toFixed(2) + ')</span></li>');
            
            subtotal += itemTotal;
            totalQuantity += itemQty;
        });
        printWindow.document.write('</ul>');

        printWindow.document.write('<div class="d-flex justify-content-between align-items-center mt-3">');
        printWindow.document.write('<strong>Total Quantity: ' + totalQuantity + '</strong>');
        printWindow.document.write('</div>');
        printWindow.document.write('<div class="d-flex justify-content-between align-items-center mt-3">');
        printWindow.document.write('<strong>Total Price (with tax): Rs. ' + totalPriceText.replace('Rs. ', '').trim() + '</strong>');
        printWindow.document.write('</div>');
        printWindow.document.write('</div></body></html>');
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }

    // Function to print the receipt with order details
    function printReceipt() {
        let items = document.querySelectorAll('#items li');
        let totalPriceText = document.getElementById('totalPrice').innerText;

        let printWindow = window.open('', 'Print Receipt', 'width=600,height=400');
        printWindow.document.write('<html><head><title>Receipt</title>');
        printWindow.document.write('<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">');
        printWindow.document.write('<style>@media print { @page { size: auto; margin: 10mm; } .no-print { display: none; } }</style>');
        printWindow.document.write('</head><body>');

        printWindow.document.write('<div class="container">');
        printWindow.document.write('<h3>Order Receipt</h3>');

        let subtotal = 0;
        let totalQuantity = 0;
        let itemCount = 0;

        printWindow.document.write('<ul class="list-group">');
        items.forEach((item) => {
            let itemName = item.querySelector('.item-name') ? item.querySelector('.item-name').innerText : 'Unknown';
            let itemQty = item.querySelector('.qty-input') ? parseInt(item.querySelector('.qty-input').value) : 0;
            let itemPrice = item.querySelector('.original-item-price') ? parseFloat(item.querySelector('.original-item-price').innerText.replace('Rs. ', '').trim()) : 0;

            if (itemName === 'Unknown' || itemQty === 0) return;

            itemCount++;
            let itemTotal = itemQty * itemPrice;

            printWindow.document.write('<li class="list-group-item d-flex justify-content-between align-items-center">' +
                itemCount + ': ' + itemName +
                '<span>(Qty: ' + itemQty +
                ', Unit Price: Rs. ' + itemPrice.toFixed(2) +
                ', Total: Rs. ' + itemTotal.toFixed(2) + ')</span></li>');
            
            subtotal += itemTotal;
            totalQuantity += itemQty;
        });
        printWindow.document.write('</ul>');

        printWindow.document.write('<div class="d-flex justify-content-between align-items-center mt-3">');
        printWindow.document.write('<strong>Total Quantity: ' + totalQuantity + '</strong>');
        printWindow.document.write('</div>');
        printWindow.document.write('<div class="d-flex justify-content-between align-items-center mt-3">');
        printWindow.document.write('<strong>Total Price (with tax): Rs. ' + totalPriceText.replace('Rs. ', '').trim() + '</strong>');
        printWindow.document.write('</div>');

        printWindow.document.write('</div></body></html>');
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }

    // Event listener for print cart items button
    document.getElementById('printCartItems').addEventListener('click', printCartItems);

    // Event listener for print receipt button
    document.getElementById('printReceipt').addEventListener('click', printReceipt);

    // Update Popover
    $('#popcart').popover();
    updatePopover(cart);
</script>








{% comment %} old script  {% endcomment %}
<script>
    
     // Initialize cart from localStorage
     if (localStorage.getItem('cart') == null) {
        var cart = {};
    } else {
        cart = JSON.parse(localStorage.getItem('cart'));
    }

    // Function to update only the specific cart item UI
    function updateCartItem(itemId) {
        var [qty, name, itemPrice] = cart[itemId];
        var sumPrice = qty * itemPrice;

        // Update the item's quantity and total price in the UI
        $(`#val-${itemId}`).val(qty);
        $(`#price-${itemId}`).html(`Rs. ${sumPrice}`);

        // Update total cart price
        updateTotalPrice();
    }

    // Function to update the total price only
    function updateTotalPrice() {
        var totalPrice = 0;
        for (var item in cart) {
            var sumPrice = cart[item][0] * cart[item][2];
            totalPrice += sumPrice;
        }
        $('#totalPrice').html(`Rs. ${totalPrice}`);
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    // Function to initialize the cart UI
    function initializeCart(cart) {
        var cartItems = '';

        for (var item in cart) {
            var [qty, name, itemPrice] = cart[item];
            var sumPrice = qty * itemPrice;

            cartItems += `
                <li class="order-item list-group-item d-flex justify-content-between align-items-center" id="item-${item}">
                    <div class="item-info">
                        <i class="fas hover-icon remove-item" id="remove-${item}" style="cursor: pointer;">&#xf057;</i>
                        <img src="https://content.jdmagicbox.com/v2/comp/pandharpur/e5/9999p2186.2186.240102180603.t9e5/catalogue/hotel-royal-shetkari-bhandishegaon-pandharpur-restaurants-m844m8eap3.jpg" alt="" width="50" height="50"/>
                        <div class="item-name">${name}</div>
                    </div>
                    <div class="item-quantity">
                        <button id="minus-${item}" class="btn btn-primary btn-sm minus">-</button>
                        <input type="number" id="val-${item}" class="form-control qty-input" value="${qty}" min="0"/>
                        <button id="plus-${item}" class="btn btn-primary btn-sm plus">+</button>
                    </div>
                    <div class="original-item-price">
                        Rs. ${itemPrice}
                        <div id="price-${item}" class="item-price">Rs. ${sumPrice}</div>
                    </div>
                </li>`;
        }

        $('#items').html(cartItems);
        updateTotalPrice();
    }

    // Initial call to initialize the cart
    initializeCart(cart);

    // Add functionality for increasing/decreasing quantity
    $('#items').on('click', 'button.minus', function() {
        var id = this.id.split('-')[1];
        cart[id][0] = Math.max(0, cart[id][0] - 1);
        if (cart[id][0] == 0) {
            delete cart[id];
            $(`#item-${id}`).remove(); // Remove the item if quantity is zero
        } else {
            updateCartItem(id); // Update only the specific item
        }
    });

    $('#items').on('click', 'button.plus', function() {
        var id = this.id.split('-')[1];
        cart[id][0] += 1;
        updateCartItem(id); // Update only the specific item
    });

    // Update quantity directly from input field
    $('#items').on('change', 'input.qty-input', function() {
        var id = this.id.split('-')[1];
        var newQty = parseInt(this.value);
        if (newQty > 0) {
            cart[id][0] = newQty;
            updateCartItem(id); // Update only the specific item
        } else {
            delete cart[id];
            $(`#item-${id}`).remove(); // Remove the item if quantity is zero
        }
    });

    // Functionality to remove an item when clicking the remove icon
    $('#items').on('click', '.remove-item', function() {
        var id = this.id.split('-')[1];
        delete cart[id];
        $(`#item-${id}`).remove(); // Remove the item from the UI
        updateTotalPrice(); // Update the total price after removal
    });

    // Prevent form submission if cart is empty
    $('#checkoutForm').on('submit', function(event) {
        if (Object.keys(cart).length === 0) {
            event.preventDefault();
            alert('Your cart is empty. Please add items before checkout.');
        }
    });

    // Refresh button functionality
    $('#refreshCart').on('click', function() {
        initializeCart(cart); // Re-initialize the cart UI on button click
    });

    </script>










    <script>


        // Initialize cart from localStorage or create a new cart
        var cart = JSON.parse(localStorage.getItem('cart')) || {};

        // Update the cart display
        function updateCart() {
            var totalItems = 0;
            var totalPrice = 0;
            var cartItems = '';
            var i = 0;

            for (var item in cart) {
                var name = cart[item][1];
                var qty = cart[item][0];
                var itemPrice = cart[item][2];
                var itemTotal = qty * itemPrice;

                totalItems += qty;
                totalPrice += itemTotal;
                cartItems += `<li class="order-item list-group-item d-flex justify-content-between align-items-center">
                    <div class="item-info">
                        <i class="fas hover-icon remove-item" id="delete${item}" style="cursor: pointer;">&#xf057;</i>
                        <img src="https://content.jdmagicbox.com/v2/comp/pandharpur/e5/9999p2186.2186.240102180603.t9e5/catalogue/hotel-royal-shetkari-bhandishegaon-pandharpur-restaurants-m844m8eap3.jpg" alt="" width="30" height="30"/>
                        <div class="item-name"><a href='/shop/search/?search=${name}' class='alert-link'><span>${++i}: ${name}</span></a></div>
                    </div>
                    <div class="item-quantity">
                        <button id="decrease${item}" class="btn btn-primary btn-sm decrease">-</button>
                        <input type="number" id="val-${item}" class="form-control qty-input" value="${qty}" min="0"/>
                        <button id="increase${item}" class="btn btn-primary btn-sm increase">+</button>
                    </div>
                    <div class="original-item-price">
                        Rs. ${itemPrice}
                        <div class="item-price">Rs. ${itemTotal}</div>
                    </div>
                </li>`;
            }

            cartItems += `<li class="list-group-item d-flex justify-content-between align-items-center" style="background: bisque;">
                <span>TOTAL PRICE:</span>
                <span class="badge badge-danger badge-pill" id="totalPrice">Rs. ${totalPrice} /-</span>
            </li>`;

            $('#items').html(cartItems);
            localStorage.setItem('cart', JSON.stringify(cart));
            $('#itemsJson').val(JSON.stringify(cart));
            $('#amount').val(totalPrice);
        }

        // Event listeners for cart buttons
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('cart')) {
                var idstr = event.target.id.toString().slice(2);
                if (cart[idstr]) {
                    cart[idstr][0] += 1;
                    showNotification(cart[idstr][1] + " quantity increased to " + cart[idstr][0]);
                } else {
                    var name = document.getElementById('namepr' + idstr).innerHTML;
                    var price = parseInt(document.getElementById('pricepr' + idstr).innerText.replace('Rs. ', '').replace(' /-', ''));
                    cart[idstr] = [1, name, price];
                    showNotification(cart[idstr][1] + " added to cart");
                }
                updateCart();
            }
        });

        // Add and remove item functionality
        $('#items').on('click', 'button.decrease', function() {
            var id = this.id.slice(8); // Change index based on the new button ID prefix
            if (cart[id]) {
                cart[id][0] = Math.max(0, cart[id][0] - 1);
                if (cart[id][0] === 0) {
                    delete cart[id];
                }
                updateCart();
            }
        });

        $('#items').on('click', 'button.increase', function() {
            var id = this.id.slice(8); // Change index based on the new button ID prefix
            if (cart[id]) {
                cart[id][0] += 1;
                updateCart();
            }
        });

        // Update quantity directly from input
        $('#items').on('change', 'input.qty-input', function() {
            var id = this.id.slice(3);
            var newQty = parseInt(this.value);
            if (newQty > 0) {
                cart[id][0] = newQty;
            } else {
                delete cart[id];
            }
            updateCart();
        });

        // Delete item
        $('#items').on('click', 'i.remove-item', function() { // Update the selector to match the correct icon
            var id = this.id.slice(6);
            delete cart[id];
            updateCart();
        });

        // Prevent form submission if cart is empty
        $('#checkoutForm').on('submit', function(event) {
            if (Object.keys(cart).length === 0) {
                event.preventDefault(); // Prevent form submission
                alert('Your cart is empty. Please add items to your cart before checking out.'); // Alert the user
            }
        });

        // Handle form submission success
        {% if messages %}
            {% for message in messages %}
                alert('{{ message }}');
            {% endfor %}
            localStorage.removeItem('cart');
            updateCart();
        {% endif %}

        // Function to show notifications
        function showNotification(message) {
            var notification = document.getElementById('notification');
            notification.innerText = message;
            notification.style.display = 'block';
            setTimeout(function() {
                notification.style.display = 'none';
            }, 2000);
        }

        // Clear cart functionality
        $('#clearCart').on('click', function() {
            cart = {}; // Clear the cart object
            localStorage.removeItem('cart'); // Remove cart from localStorage
            $('#items').html(''); // Clear the cart items in the UI
            $('#totalPrice').html('Rs. 0'); // Reset total price
            alert('Your cart has been cleared.'); // Notify the user
        });

        $('#refreshPage').on('click', function() {
            location.reload(); // Refresh the page
        });

        // Initial cart update
        updateCart();

</script>
    
    
{% endblock %}
